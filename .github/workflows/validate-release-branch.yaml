name: Validate Release Branch

on:
  pull_request:
    branches:
      - 'release-*'

jobs:
  validate-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get target branch
        id: branch
        run: |
          echo "target=${{ github.base_ref }}" >> $GITHUB_OUTPUT

      - name: Validate release branch versions
        run: |
          BRANCH="${{ steps.branch.outputs.target }}"
          SEMVER="${BRANCH#release-}"

          # Validate semver format
          if ! [[ "$SEMVER" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Branch name must follow 'release-X.Y.Z' semver format"
            exit 1
          fi

          CHART_VERSION=$(yq eval '.version' deployment/console-plugin-nvidia-gpu/Chart.yaml)
          APP_VERSION=$(yq eval '.appVersion' deployment/console-plugin-nvidia-gpu/Chart.yaml)

          if [[ "$CHART_VERSION" != "$SEMVER" ]]; then
            echo "❌ Chart version must be '$SEMVER', found '$CHART_VERSION'"
            exit 1
          fi

          if [[ "$APP_VERSION" != "v${SEMVER}" && "$APP_VERSION" != "release-${SEMVER}" ]]; then
            echo "❌ appVersion must be 'v${SEMVER}' or 'release-${SEMVER}', found '$APP_VERSION'"
            exit 1
          fi

          echo "✓ Versions match branch"
