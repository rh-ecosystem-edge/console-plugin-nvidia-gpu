name: Validate versions

on:
  pull_request:
    branches:
      - 'release-*'
      - gh-pages

jobs:
  validate-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get target branch
        id: branch
        run: |
          echo "target=${{ github.base_ref }}" >> $GITHUB_OUTPUT

      - name: Validate release branch versions
        if: startsWith(steps.branch.outputs.target, 'release-')
        run: |
          BRANCH="${{ steps.branch.outputs.target }}"
          SEMVER="${BRANCH#release-}"

          # Validate semver format
          if ! [[ "$SEMVER" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Branch name must follow 'release-X.Y.Z' semver format"
            exit 1
          fi

          CHART_VERSION=$(yq eval '.version' deployment/console-plugin-nvidia-gpu/Chart.yaml)
          APP_VERSION=$(yq eval '.appVersion' deployment/console-plugin-nvidia-gpu/Chart.yaml)

          if [[ "$CHART_VERSION" != "$SEMVER" ]]; then
            echo "❌ Chart version must be '$SEMVER', found '$CHART_VERSION'"
            exit 1
          fi

          if [[ "$APP_VERSION" != "v${SEMVER}" && "$APP_VERSION" != "release-${SEMVER}" ]]; then
            echo "❌ appVersion must be 'v${SEMVER}' or 'release-${SEMVER}', found '$APP_VERSION'"
            exit 1
          fi

          echo "✓ Versions match branch"

      - name: Validate gh-pages index.yaml
        if: steps.branch.outputs.target == 'gh-pages'
        run: |
          # Check for duplicate versions
          DUPLICATES=$(yq eval '.entries.console-plugin-nvidia-gpu[].version' index.yaml | sort | uniq -d)
          if [[ -n "$DUPLICATES" ]]; then
            echo "❌ Duplicate versions: $DUPLICATES"
            exit 1
          fi

          # Check if any appVersion doesn't match v{version} or release-{version}
          # (skip 0.1.0 for backwards compatibility)
          INVALID=$(yq eval '.entries.console-plugin-nvidia-gpu[] | select(.version != "0.1.0" and .appVersion != "v" + .version and .appVersion != "release-" + .version) | .version' index.yaml)
          if [[ -n "$INVALID" ]]; then
            echo "❌ Found entries with invalid appVersion:"
            while IFS= read -r VERSION; do
              APP_VERSION=$(yq eval ".entries.console-plugin-nvidia-gpu[] | select(.version == \"$VERSION\") | .appVersion" index.yaml | head -1)
              echo "   Version $VERSION has appVersion='$APP_VERSION', expected 'v$VERSION' or 'release-$VERSION'"
            done <<< "$INVALID"
            exit 1
          fi

          COUNT=$(yq eval '.entries.console-plugin-nvidia-gpu | length' index.yaml)
          echo "✓ All $COUNT versions valid"
