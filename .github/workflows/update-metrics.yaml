name: Update DCGM Metrics

on:
  schedule:
    - cron: '0 9 1 * *'  # Monthly on the 1st at 9 AM UTC
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    if: github.repository == 'rh-ecosystem-edge/console-plugin-nvidia-gpu'
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Run update-metrics script
        run: ./scripts/update-metrics.sh

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet deployment/console-plugin-nvidia-gpu/files/dcgm-metrics.csv; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update DCGM metrics from upstream"
          branch: update-dcgm-metrics
          delete-branch: true
          title: "Update DCGM metrics from upstream"
          body: |
            This PR updates the DCGM metrics file with the latest metrics from upstream.

            The metrics file is merged from:
            - `scripts/required-metrics.csv` (metrics required by this plugin)
            - [Upstream DCGM exporter defaults](https://github.com/NVIDIA/dcgm-exporter/blob/main/etc/dcp-metrics-included.csv)

            This PR was automatically created by the [Update DCGM Metrics workflow](https://github.com/${{ github.repository }}/actions/workflows/update-metrics.yaml).

      - name: Create failure issue
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh issue create \
            --repo ${{ github.repository }} \
            --title "DCGM metrics update workflow failed" \
            --body "$(cat <<EOF
          The [Update DCGM Metrics workflow]($WORKFLOW_URL) failed.

          **Workflow run:** $WORKFLOW_URL
          **Triggered by:** ${{ github.event_name }}
          **Run date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          Please investigate the failure and fix the issue.
          EOF
          )"
